language: android 
android: 
  components: 
    - build-tools-27.0.3
    - android-27
    - extra-google-google_play_services
    - addon-google_apis-google-27
jdk:
  - openjdk8
  
addons:
  apt:
    packages:
      - git
      - make

before_install: 
  - mkdir -p app/secrets/raw
  - openssl aes-256-cbc -K $encrypted_b494ab82b075_key -iv $encrypted_b494ab82b075_iv -in app/secrets/raw.tar.gz.enc -out app/secrets/raw.tar.gz -d
  - tar -xzvf app/secrets/raw.tar.gz
  - mv app/secrets/raw/google-services.json app/

before_script:
  - make travis-version
  - make commit-message
  - make tag-message

script:
  - ./gradlew assemble
  - find . -name '*.apk'
  - ./gradlew checkstyleAndroid
  
cache: 
  directories: 
    - $HOME/.gradle/caches/ 
    - $HOME/.gradle/wrapper/ 
    - $HOME/.android/build-cache
  
before_deploy:
  - export VERSION=$(make travis-version)
  - export COMMIT_MESSAGE=$(make commit-message)
  - export TAG_MESSAGE=$(make tag-message)
  
  - export ART_DEBUG_APK="debug-${VERSION}.apk"
  - export ART_RELEASE_APK="release-${VERSION}.apk"
  - export ART_CHECKSTYLE=${VERSION}_checkstyle.html
  - export ART_LINT=${VERSION}_lint.html
  
  - mv app/build/outputs/apk/dev/debug/app-dev-debug.apk $ART_DEBUG_APK
  - mv app/build/outputs/apk/dev/release/app-dev-release.apk $ART_RELEASE_APK
  - mv app/build/reports/checkstyle/android.html $ART_CHECKSTYLE
  
  - git config --local user.name "Travis Bot"
  - git config --local user.email "travis@gmail.com"
  - git tag -f -a -m '${VERSION}: ${COMMIT_MESSAGE}' -m '${TAG_MESSAGE}' '${VERSION}'

deploy:
  provider: releases
  api_key: ${DEPLOY_TOKEN}
  file: 
    - ${ART_DEBUG_APK}
    - ${ART_RELEASE_APK}
    - ${ART_CHECKSTYLE}
  skip_cleanup: true 
  prerelease: true
  on:
    branch:
      - master
      - force-deploy
      - force-deploy-aglubshev
      - force-deploy-odemianchenko
      - force-deploy-dteterin
    tags: false
    condition: $TRAVIS_PULL_REQUEST = false
