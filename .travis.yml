language: python

python:
  - "3.6"
  
sudo: required

services:
  - docker

install:
  - pip3 install -r requirements.txt
  
before_script:
  - git config --local user.name "Borodin Gregory"
  - git config --local user.email "grihabor@gmail.com"
  - export GIT_COMMIT=$(git log --format=%h -1)
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
 
script:
  - export IMAGE=grihabor/garbage.clicker:$GIT_COMMIT
  - docker build . -t $IMAGE
  - echo -e "travis_fold:start:push.image\033[33;1mPushing docker image\033[0m"
  - docker push $IMAGE
  - docker run --name build $IMAGE
  - docker cp build:/project/app/build/outputs/apk/dev/debug/app-dev-debug.apk .
  - docker cp build:/project/app/build/reports reports
  - echo -e "\ntravis_fold:end:push.image\r"
  
after_success:  
  - python3 parse_report.py reports/checkstyle/android.xml
  - python3 parse_report.py reports/lint-results.xml
  
before_deploy:
  - mv app-dev-debug.apk "${GIT_COMMIT}.apk"
  - mv reports/checkstyle/android.html "checkstyle_${GIT_COMMIT}.html"
  - mv reports/lint-results.html "lint_${GIT_COMMIT}.html"
  - git tag "${GIT_COMMIT}_${TRAVIS_BRANCH}_$(date +'%Y-%m-%d_%H-%M-%S')"

deploy:
  provider: releases
  api_key: ${DEPLOY_TOKEN}
  file: 
    - ${GIT_COMMIT}.apk
    - checkstyle_${GIT_COMMIT}.html
    - lint_${GIT_COMMIT}.html
  skip_cleanup: true 
  prerelease: true
  on:
    all_branches: true
    condition: $TRAVIS_PULL_REQUEST = false
