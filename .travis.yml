language: python

python:
  - "3.6"
  
sudo: required

services:
  - docker

install:
  - pip3 install -r requirements.txt
  
before_script:
  - git config --local user.name "Borodin Gregory"
  - git config --local user.email "grihabor@gmail.com"
  - export GIT_COMMIT=$(git log --format=%h -1)
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
 
script:
  - export IMAGE=grihabor/garbage.clicker:$GIT_COMMIT
  - docker build . -t $IMAGE
  - docker push $IMAGE
  - docker run --name build $IMAGE
  - docker cp build:/project/app/build/outputs/apk/debug/app-debug.apk .
  - docker cp build:/project/app/build/reports/lint-results.xml .
  - docker cp build:/project/app/build/reports/checkstyle/android.xml .
  
after_success:  
  - python3 parse_report.py android.xml
  - python3 parse_report.py lint-results.xml
  
before_deploy:
  - mv app-debug.apk "$GIT_COMMIT.apk"
  - git tag "$(date +'%Y-%m-%d_%H-%M-%S')_$GIT_COMMIT"

deploy:
  provider: releases
  api_key: ${DEPLOY_TOKEN}
  file: ${GIT_COMMIT}.apk
  skip_cleanup: true 
  prerelease: true
  on:
    branch:
      - master
 
