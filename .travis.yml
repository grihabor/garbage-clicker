sudo: required

services:
  - docker

install:
  - sudo apt update
  - sudo apt install make git

before_script:
  - git config --local user.name "Borodin Gregory"
  - git config --local user.email "grihabor@gmail.com"
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
 
script:
  - export IMAGE="$(make image)"
  - docker build . -t $IMAGE
  
after_success:
  - docker push $IMAGE
  - docker run --name build $IMAGE
  - docker cp build:/project/app/build/outputs/apk/dev/debug/app-dev-debug.apk ./debug.apk
  - docker cp build:/project/app/build/outputs/apk/dev/release/app-dev-release-unsigned.apk ./release-unsigned.apk
  - docker cp build:/project/app/build/reports reports
  
before_deploy:
  - export VERSION=$(make travis-version)
  - export ART_DEBUG_APK="debug-${VERSION}.apk"
  - export ART_RELEASE_APK="release-${VERSION}.apk"
  - export ART_CHECKSTYLE=${VERSION}_checkstyle.html
  - export ART_LINT=${VERSION}_lint.html
  - mv debug.apk $ART_DEBUG_APK
  - mv release-unsigned.apk $ART_RELEASE_APK
  - mv reports/checkstyle/android.html $ART_CHECKSTYLE
  - mv reports/lint-results.html $ART_LINT
  - git tag ${VERSION}

deploy:
  provider: releases
  api_key: ${DEPLOY_TOKEN}
  file: 
    - ${ART_DEBUG_APK}
    - ${ART_RELEASE_APK}
    - ${ART_CHECKSTYLE}
    - ${ART_LINT}
  skip_cleanup: true 
  prerelease: true
  on:
    branch:
      - master
      - force-build
    tags: false
    condition: $TRAVIS_PULL_REQUEST = false
