language: python

python:
  - "3.6"
  
sudo: required

services:
  - docker

install:
  - apt update
  - apt install make git
  - pip3 install -r requirements.txt
  
before_script:
  - git config --local user.name "Borodin Gregory"
  - git config --local user.email "grihabor@gmail.com"
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
 
script:
  - export IMAGE="$(make image)"
  - docker build . -t $IMAGE
  - echo -e "travis_fold:start:push.image\033[33;1mPushing docker image\033[0m"
  - docker push $IMAGE
  - docker run --name build $IMAGE
  - docker cp build:/project/app/build/outputs/apk/dev/debug/app-dev-debug.apk .
  - docker cp build:/project/app/build/reports reports
  - echo -e "\ntravis_fold:end:push.image\r"
  
after_success:  
  - python3 parse_report.py reports/checkstyle/android.xml
  - python3 parse_report.py reports/lint-results.xml
  
before_deploy:
  - export VERSION=$(make version)
  - export ART_APK=${VERSION}.apk
  - export ART_CHECKSTYLE=${VERSION}_checkstyle.html
  - export ART_LINT=${VERSION}_lint.html
  - mv app-dev-debug.apk $ART_APK
  - mv reports/checkstyle/android.html $ART_CHECKSTYLE
  - mv reports/lint-results.html $ART_LINT
  - git tag ${VERSION}
  - git tag ${VERSION}_${TRAVIS_BRANCH}

deploy:
  provider: releases
  api_key: ${DEPLOY_TOKEN}
  file: 
    - ${ART_APK}
    - ${ART_CHECKSTYLE}
    - ${ART_LINT}
  skip_cleanup: true 
  prerelease: true
  on:
    all_branches: true
    condition: $TRAVIS_PULL_REQUEST = false
